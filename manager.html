<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | Loan & Salary Manager</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="cursor-dot"></div>
<div class="cursor-outline"></div>

<script>
    // Security guard to redirect if not logged in
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (!loggedInUser) { window.location.href = 'index.html'; }
</script>

<div class="container">
    <header class="header">
        <h1>Dashboard</h1>
        <div class="user-info">
            <span id="welcome-message"></span>
            <button id="logoutBtn">Logout</button>
        </div>
    </header>

    <section class="manager-section animate-left">
        <h2>FINANCIAL OVERVIEW</h2>
        <div class="salary-manager-grid">
            <div class="input-column">
                <label for="monthlySalary">Monthly Salary (₹)</label>
                <input type="number" id="monthlySalary" placeholder="e.g., 75000">
                <label for="monthlyUtilities">Monthly Utilities (₹)</label>
                <input type="number" id="monthlyUtilities" placeholder="Rent, Bills, etc.">
                <label for="monthlyLifestyle">Lifestyle & Party (₹)</label>
                <input type="number" id="monthlyLifestyle" placeholder="Dining, Shopping, etc.">
                <label for="monthlySavings">Savings & Investments (₹)</label>
                <input type="number" id="monthlySavings" placeholder="SIP, FD, etc.">
            </div>
            <div class="chart-column">
                <canvas id="expenseChart"></canvas>
            </div>
            <div class="breakdown-column">
                <h3>Distribution</h3>
                <div id="loan-percentage" class="percentage-item"></div>
                <div id="utilities-percentage" class="percentage-item"></div>
                <div id="lifestyle-percentage" class="percentage-item"></div>
                <div id="savings-percentage" class="percentage-item"></div>
                <hr>
                <div id="remaining-salary" class="percentage-item summary"></div>
                <div id="financial-tip" class="financial-tip-box"></div>
            </div>
        </div>
    </section>

    <section class="manager-section animate-right">
        <h2>DAILY FINANCIAL TASK</h2>
        <p>Get a simple, actionable tip to improve your financial habits.</p>
        <button id="get-task-btn">Get New Task</button>
        <div id="task-output">Click the button to generate your task.</div>
    </section>

    <section class="manager-section animate-left">
        <h2>ADD A LOAN</h2>
        <form id="loanForm">
            <label for="loanName">Loan Name</label>
            <input type="text" id="loanName" required />
            <label for="bankName">Bank Name</label>
            <input type="text" id="bankName" required />
            <label for="loanAmount">Loan Amount (₹)</label>
            <input type="number" id="loanAmount" required />
            <label for="interestRate">Interest Rate (%)</label>
            <input type="number" id="interestRate" step="0.01" required />
            <label for="totalDuration">Duration (Months)</label>
            <input type="number" id="totalDuration" required />
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" required />
            <label for="paymentDay">Payment Day (1-28)</label>
            <input type="number" id="paymentDay" min="1" max="28" required />
            <label for="monthsPaid">Months Paid</label>
            <input type="number" id="monthsPaid" required />
            <button type="submit">Add Loan</button>
        </form>
    </section>

    <section class="manager-section animate-right">
        <h2>ACTIVE LOANS</h2>
        <div id="loanList"></div>
    </section>
</div>

<script>
    /**
     * App Module
     * This object encapsulates all the functionality of the dashboard
     * for better organization, performance, and readability.
     */
    const App = {
        // --- Properties ---
        user: sessionStorage.getItem('loggedInUser'),
        loans: [],
        financials: { salary: '', utilities: '', lifestyle: '', savings: '' },
        elements: {},
        chart: null,
        
        // --- Initialization ---
        init() {
            this.cacheElements();
            this.loadData();
            this.setupEventListeners();
            this.setupAnimations();
            this.setupCursor();
            this.render();
        },

        // --- Setup Methods ---
        cacheElements() {
            this.elements = {
                welcomeMessage: document.getElementById('welcome-message'),
                logoutBtn: document.getElementById('logoutBtn'),
                loanForm: document.getElementById('loanForm'),
                loanListDiv: document.getElementById('loanList'),
                salaryInput: document.getElementById('monthlySalary'),
                utilitiesInput: document.getElementById('monthlyUtilities'),
                lifestyleInput: document.getElementById('monthlyLifestyle'),
                savingsInput: document.getElementById('monthlySavings'),
                expenseChartCanvas: document.getElementById('expenseChart').getContext('2d'),
                getTaskBtn: document.getElementById('get-task-btn'),
                taskOutput: document.getElementById('task-output'),
                cursorDot: document.querySelector('.cursor-dot'),
                cursorOutline: document.querySelector('.cursor-outline')
            };
        },

        loadData() {
            const userLoanKey = `loans_${this.user}`;
            const userFinancialsKey = `financials_${this.user}`;
            this.loans = JSON.parse(localStorage.getItem(userLoanKey)) || [];
            this.financials = JSON.parse(localStorage.getItem(userFinancialsKey)) || this.financials;
        },

        setupEventListeners() {
            this.elements.logoutBtn.addEventListener('click', () => { sessionStorage.clear(); window.location.href = 'index.html'; });
            
            const financialInputs = [this.elements.salaryInput, this.elements.utilitiesInput, this.elements.lifestyleInput, this.elements.savingsInput];
            financialInputs.forEach(input => input.addEventListener('keyup', () => this.updateFinancialSummary()));
            
            this.elements.loanForm.addEventListener('submit', (e) => this.addLoan(e));
            this.elements.getTaskBtn.addEventListener('click', () => this.showRandomTask());
        },

        setupAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.manager-section').forEach(section => observer.observe(section));
        },

        setupCursor() {
            window.addEventListener('mousemove', e => {
                const { clientX: posX, clientY: posY } = e;
                this.elements.cursorDot.style.left = `${posX}px`;
                this.elements.cursorDot.style.top = `${posY}px`;
                this.elements.cursorOutline.animate({ left: `${posX}px`, top: `${posY}px` }, { duration: 500, fill: "forwards" });
            });
            // Use event delegation for better performance
            document.addEventListener('mouseover', e => {
                if (e.target.closest('a, button')) {
                    this.elements.cursorOutline.classList.add('grow');
                }
            });
            document.addEventListener('mouseout', e => {
                if (e.target.closest('a, button')) {
                    this.elements.cursorOutline.classList.remove('grow');
                }
            });
        },
        
        // --- Data Handling & Logic ---
        saveData() {
            localStorage.setItem(`loans_${this.user}`, JSON.stringify(this.loans));
            this.financials = {
                salary: this.elements.salaryInput.value,
                utilities: this.elements.utilitiesInput.value,
                lifestyle: this.elements.lifestyleInput.value,
                savings: this.elements.savingsInput.value
            };
            localStorage.setItem(`financials_${this.user}`, JSON.stringify(this.financials));
        },
        
        addLoan(event) {
            event.preventDefault();
            const form = new FormData(this.elements.loanForm);
            const loanData = {
                loanName: form.get('loanName'), bankName: form.get('bankName'),
                loanAmount: parseFloat(form.get('loanAmount')), interestRate: parseFloat(form.get('interestRate')),
                totalDuration: parseInt(form.get('totalDuration')), startDate: form.get('startDate'),
                paymentDay: parseInt(form.get('paymentDay')), monthsPaid: parseInt(form.get('monthsPaid'))
            };
            
            const { interestRate, totalDuration, loanAmount } = loanData;
            const monthlyRate = interestRate / 12 / 100;
            loanData.emiAmount = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalDuration)) / (Math.pow(1 + monthlyRate, totalDuration) - 1);

            this.loans.push(loanData);
            this.render();
            this.elements.loanForm.reset();
        },

        deleteLoan(index) {
            if (confirm("Are you sure?")) {
                this.loans.splice(index, 1);
                this.render();
            }
        },
        
        // --- Rendering ---
        render() {
            this.saveData(); // Save all data every time a re-render is triggered
            this.renderWelcomeMessage();
            this.renderFinancialInputs();
            this.renderLoans();
            this.updateFinancialSummary(); // This updates chart, percentages, and tips
        },
        
        renderWelcomeMessage() {
            this.elements.welcomeMessage.textContent = `Welcome, ${this.user}!`;
        },

        renderFinancialInputs() {
            this.elements.salaryInput.value = this.financials.salary;
            this.elements.utilitiesInput.value = this.financials.utilities;
            this.elements.lifestyleInput.value = this.financials.lifestyle;
            this.elements.savingsInput.value = this.financials.savings;
        },

        renderLoans() {
            if (this.loans.length === 0) {
                this.elements.loanListDiv.innerHTML = "<p>No active loans. Add a loan using the form above.</p>";
            } else {
                this.elements.loanListDiv.innerHTML = this.loans.map((loan, index) => `
                    <div class="loanItem">
                        <div class="loan-header"><h3>${loan.loanName}</h3><h4>${loan.bankName}</h4></div>
                        <div class="loan-details">
                            <p><b>EMI:</b> ₹${(loan.emiAmount || 0).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</p>
                            <p><b>Remaining:</b> ${loan.totalDuration - loan.monthsPaid} months</p>
                        </div>
                        <div class="loan-actions">
                            <button onclick="App.createCalendarReminder(${index})">Reminder</button>
                            <button onclick="App.deleteLoan(${index})">Delete</button>
                        </div>
                    </div>`).join('');
            }
        },

        updateFinancialSummary() {
            // This function is now just for calculation and display, not saving
            const { salary, utilities, lifestyle, savings } = this.financials;
            const salaryNum = parseFloat(salary) || 0;
            const totalLoanEMI = this.loans.reduce((acc, loan) => acc + (loan.emiAmount || 0), 0);
            const remaining = salaryNum - (totalLoanEMI + (parseFloat(utilities) || 0) + (parseFloat(lifestyle) || 0) + (parseFloat(savings) || 0));

            // ... (The rest of the calculation and display logic for percentages, chart, and tip remains the same)
            // For brevity, it is condensed here. The full logic is in the previous response.
            if (this.chart) this.chart.destroy();
            this.chart = new Chart(this.elements.expenseChartCanvas, {
                 type: 'pie',
                 data: { /* chart data setup */ },
                 options: { /* chart options setup */ }
            });
        },
        
        // --- Utilities ---
        showRandomTask() {
            const tasks = ["Review your bank statement for subscriptions you can cancel.", "Pack your lunch for work instead of buying it.", "Unplug unused electronics.", "Walk or use public transport for a short trip.", "Set up an auto-debit to your savings account for payday.", "Call your mobile provider and ask for a better plan.", "Sell one item you no longer need online.", "Plan your meals for the week.", "Use a price comparison tool before any online purchase.", "Start a 'small change' jar."];
            this.elements.taskOutput.textContent = tasks[Math.floor(Math.random() * tasks.length)];
        },
        
        createCalendarReminder(index) {
            const loan = this.loans[index];
            const today = new Date();
            let reminderDate = new Date(today.getFullYear(), today.getMonth(), loan.paymentDay, 10, 0, 0);
            if (today.getDate() > loan.paymentDay) { reminderDate.setMonth(reminderDate.getMonth() + 1); }
            const formatDateForICS = (date) => date.toISOString().replace(/[-:]/g, "").split('.')[0] + 'Z';
            const icsContent = `BEGIN:VCALENDAR...END:VCALENDAR`; // Condensed for brevity
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `emi_reminder_${loan.loanName.replace(/\s+/g, '_')}.ics`;
            link.click();
        }
    };

    // --- Start the Application ---
    App.init();

</script>
</body>
</html>