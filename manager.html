<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | Loan & Salary Manager</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="styles.css" />
</head>
<body>

<script>
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (!loggedInUser) { window.location.href = 'index.html'; }
</script>

<div class="container">
    <div class="header">
        <h1>Dashboard</h1>
        <div class="user-info">
            <span id="welcome-message"></span>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="manager-section">
        <h2>FINANCIAL OVERVIEW</h2>
        <div class="salary-manager-grid">
            <div class="input-column">
                <label for="monthlySalary">Monthly Salary (₹)</label>
                <input type="number" id="monthlySalary" placeholder="e.g., 75000">

                <label for="monthlyUtilities">Monthly Utilities (₹)</label>
                <input type="number" id="monthlyUtilities" placeholder="Rent, Bills, etc.">

                <label for="monthlyLifestyle">Lifestyle & Party (₹)</label>
                <input type="number" id="monthlyLifestyle" placeholder="Dining, Shopping, etc.">
                
                <label for="monthlySavings">Savings & Investments (₹)</label>
                <input type="number" id="monthlySavings" placeholder="SIP, FD, etc.">
            </div>
            
            <div class="chart-column">
                <canvas id="expenseChart"></canvas>
            </div>

            <div class="breakdown-column">
                <h3>Distribution</h3>
                <div id="loan-percentage" class="percentage-item"></div>
                <div id="utilities-percentage" class="percentage-item"></div>
                <div id="lifestyle-percentage" class="percentage-item"></div>
                <div id="savings-percentage" class="percentage-item"></div>
                <hr>
                <div id="remaining-salary" class="percentage-item summary"></div>
                <div id="financial-tip" class="financial-tip-box"></div>
            </div>
        </div>
    </div>

    <div class="manager-section">
        <h2>DAILY FINANCIAL TASK</h2>
        <p>Get a simple, actionable tip to improve your financial habits.</p>
        <button id="get-task-btn">Get New Task</button>
        <div id="task-output">Click the button to generate your task.</div>
    </div>

    <div class="manager-section">
        <h2>ADD A LOAN</h2>
        <form id="loanForm">
            <label for="loanName">Loan Name</label>
            <input type="text" id="loanName" required />
            <label for="bankName">Bank Name</label>
            <input type="text" id="bankName" required />
            <label for="loanAmount">Loan Amount (₹)</label>
            <input type="number" id="loanAmount" required />
            <label for="interestRate">Interest Rate (%)</label>
            <input type="number" id="interestRate" step="0.01" required />
            <label for="totalDuration">Duration (Months)</label>
            <input type="number" id="totalDuration" required />
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" required />
            <label for="paymentDay">Payment Day (1-28)</label>
            <input type="number" id="paymentDay" min="1" max="28" required />
            <label for="monthsPaid">Months Paid</label>
            <input type="number" id="monthsPaid" required />
            <button type="submit">Add Loan</button>
        </form>
    </div>

    <div class="manager-section">
        <h2>ACTIVE LOANS</h2>
        <div id="loanList"></div>
    </div>
</div>

<script>
    // The entire JavaScript logic from the previous step remains the same,
    // with one key change in the `updateFinancialSummary` function for chart colors.
    
    document.getElementById('welcome-message').textContent = `Welcome, ${loggedInUser}!`;
    document.getElementById('logoutBtn').addEventListener('click', () => { sessionStorage.clear(); window.location.href = 'index.html'; });

    const userLoanKey = `loans_${loggedInUser}`;
    const userFinancialsKey = `financials_${loggedInUser}`;
    let loans = JSON.parse(localStorage.getItem(userLoanKey)) || [];
    let financials = JSON.parse(localStorage.getItem(userFinancialsKey)) || { salary: '', utilities: '', lifestyle: '', savings: '' };
    
    // Financial Task Logic (unchanged)
    const financialTasks = ["Review your bank statement for any subscriptions you can cancel.", "Pack your lunch for work today instead of buying it.", "Unplug electronics you aren't using to save on your electricity bill.", "Walk or use public transport for a short trip instead of a cab.", "Set up an auto-debit to your savings account for the day you get paid.", "Call your mobile/internet provider and ask for a better plan or discount.", "Sell one item you no longer need on an online marketplace.", "Plan your meals for the week to avoid impulse food purchases.", "Use a price comparison website before making any online purchase.", "Start a 'small change' jar and empty your pockets into it daily.", "Brew your coffee at home instead of buying from a cafe.", "Check your tire pressure; properly inflated tires improve fuel efficiency.", "Designate one 'no-spend' day this week.", "Try a free hobby, like hiking or visiting a park, instead of paid entertainment.", "Learn a simple DIY repair skill from a YouTube video to save on service costs.", "Pay your credit card bill in full to avoid interest charges.", "Review your insurance policies to see if you can get a better deal.", "Use your local library for books and movies instead of buying them.", "Have a potluck with friends instead of dining out.", "Calculate your net worth to understand your financial standing.", "Set a specific, measurable, realistic, and time-bound (SMART) financial goal.", "Automate your investments through a Systematic Investment Plan (SIP).", "Increase your SIP amount by 5-10%.", "Read one article about personal finance or investing.", "Listen to a financial podcast during your commute.", "Create a simple monthly budget and track your spending against it.", "Identify one 'want' you can cut back on this month.", "Switch to generic brands for some of your grocery items.", "Drink more water; it's healthy and cheaper than other beverages.", "Start a side hustle with a skill you already have (e.g., writing, design).", "Consolidate high-interest debt if it makes financial sense.", "Check your credit score for free.", "Contribute to a tax-saving investment like PPF or ELSS.", "Negotiate a better rate on a recurring bill.", "Do a pantry challenge: cook meals using only ingredients you already have.", "Take a reusable water bottle and coffee cup when you go out.", "Mend a piece of clothing instead of replacing it.", "Borrow tools or equipment from a friend or neighbor instead of buying.", "Find a cheaper alternative for your gym membership.", "Learn about the power of compound interest.", "Set a goal to save for a large purchase instead of using EMI.", "Open a high-yield savings account.", "Review your investment portfolio's asset allocation.", "Buy seasonal fruits and vegetables as they are often cheaper.", "Make a grocery list and stick to it.", "Avoid shopping when you're hungry or emotional.", "Use cashback apps or credit cards with good rewards.", "Freeze leftover food to eat later.", "Set a 24-hour waiting period for any non-essential purchase over ₹1000.", "Create a 'dream board' for your financial goals to stay motivated."];
    const getTaskBtn = document.getElementById('get-task-btn');
    const taskOutput = document.getElementById('task-output');
    getTaskBtn.addEventListener('click', () => { const randomIndex = Math.floor(Math.random() * financialTasks.length); taskOutput.textContent = financialTasks[randomIndex]; });

    // Salary Manager Logic
    const salaryInput = document.getElementById('monthlySalary');
    const utilitiesInput = document.getElementById('monthlyUtilities');
    const lifestyleInput = document.getElementById('monthlyLifestyle');
    const savingsInput = document.getElementById('monthlySavings');
    const expenseChartCanvas = document.getElementById('expenseChart').getContext('2d');
    let expenseChart = new Chart(expenseChartCanvas, { type: 'pie', data: { labels: [], datasets: [] } });
    salaryInput.value = financials.salary;
    utilitiesInput.value = financials.utilities;
    lifestyleInput.value = financials.lifestyle;
    savingsInput.value = financials.savings;
    
    function updateFinancialSummary() {
        financials = { salary: salaryInput.value, utilities: utilitiesInput.value, lifestyle: lifestyleInput.value, savings: savingsInput.value };
        localStorage.setItem(userFinancialsKey, JSON.stringify(financials));
        const salary = parseFloat(salaryInput.value) || 0;
        const utilities = parseFloat(utilitiesInput.value) || 0;
        const lifestyle = parseFloat(lifestyleInput.value) || 0;
        const savings = parseFloat(savingsInput.value) || 0;
        const totalLoanEMI = loans.reduce((acc, loan) => acc + loan.emiAmount, 0);
        const totalExpenses = totalLoanEMI + utilities + lifestyle + savings;
        const remaining = salary - totalExpenses;
        const displayPercentage = (id, label, value) => {
            const element = document.getElementById(id);
            if (salary > 0) {
                const percentage = ((value / salary) * 100).toFixed(1);
                element.innerHTML = `<span>${label}:</span> <strong>${percentage}%</strong>`;
            } else { element.innerHTML = `<span>${label}:</span> <strong>-</strong>`; }
        };
        displayPercentage('loan-percentage', 'Loans EMI', totalLoanEMI);
        displayPercentage('utilities-percentage', 'Utilities', utilities);
        displayPercentage('lifestyle-percentage', 'Lifestyle', lifestyle);
        displayPercentage('savings-percentage', 'Savings', savings);
        const remainingEl = document.getElementById('remaining-salary');
        remainingEl.innerHTML = `<span>Remaining:</span> <strong>₹${remaining.toLocaleString('en-IN')}</strong>`;
        remainingEl.style.color = remaining < 0 ? '#ef5350' : '#66bb6a';

        // *** UPDATED CHART CONFIGURATION ***
        const chartData = [totalLoanEMI, utilities, lifestyle, savings, Math.max(0, remaining)];
        const chartLabels = ['Loans EMI', 'Utilities', 'Lifestyle', 'Savings', 'Remaining'];
        expenseChart.destroy();
        expenseChart = new Chart(expenseChartCanvas, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: ['#EDFF00', '#B0B0B0', '#777777', '#FFFFFF', '#444444'], // New Colors
                    borderColor: '#121212', // Match background
                    borderWidth: 2
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: { color: '#F5F5F5' } // New legend text color
                    } 
                } 
            }
        });
        
        // Financial Tip Logic (unchanged)
        const tipEl = document.getElementById('financial-tip');
        if (salary > 0) {
            const loanPercent = (totalLoanEMI / salary) * 100;
            const savingPercent = (savings / salary) * 100;
            if (loanPercent > 50) { tipEl.innerHTML = "<strong>Tip:</strong> Your loan payments are over 50% of your income. Focus on increasing income or prepaying loans."; } 
            else if (savingPercent < 10) { tipEl.innerHTML = "<strong>Tip:</strong> Your savings rate is below 10%. Try to increase your savings, even by a small amount."; } 
            else if (savingPercent > 20) { tipEl.innerHTML = "<strong>Tip:</strong> Excellent! Your savings rate is over 20%. You are on a great track for financial independence."; } 
            else { tipEl.innerHTML = "<strong>Tip:</strong> You have a balanced financial distribution. Keep tracking to stay on course!"; }
        } else { tipEl.innerHTML = "<strong>Tip:</strong> Enter your salary to get personalized financial tips."; }
    }
    [salaryInput, utilitiesInput, lifestyleInput, savingsInput].forEach(input => input.addEventListener('keyup', updateFinancialSummary));

    // Loan Management Logic (unchanged)
    const loanForm = document.getElementById('loanForm');
    const loanListDiv = document.getElementById('loanList');
    function saveLoans() { localStorage.setItem(userLoanKey, JSON.stringify(loans)); }
    function calculateEMI(p, r, n) { if (r === 0) return p / n; const m = r / 12 / 100; return (p * m * Math.pow(1 + m, n)) / (Math.pow(1 + m, n) - 1); }
    function renderLoans() {
        if (loans.length === 0) { loanListDiv.innerHTML = "<p>No active loans. Add a loan using the form above.</p>"; }
        else {
            loanListDiv.innerHTML = loans.map((loan, index) => `
                <div class="loanItem">
                    <div class="loan-header"><h3>${loan.loanName}</h3><h4>${loan.bankName}</h4></div>
                    <div class="loan-details">
                        <p><b>EMI:</b> ₹${loan.emiAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</p>
                        <p><b>Remaining:</b> ${loan.totalDuration - loan.monthsPaid} months</p>
                    </div>
                    <div class="loan-actions">
                        <button class="reminder-btn" onclick="createCalendarReminder(${index})">Reminder</button>
                        <button class="delete-btn" onclick="deleteLoan(${index})">Delete</button>
                    </div>
                </div>`).join('');
        }
        updateFinancialSummary();
    }
    function deleteLoan(index) { if(confirm("Are you sure?")) { loans.splice(index, 1); saveLoans(); renderLoans(); } }
    function createCalendarReminder(index) {
        const loan = loans[index];
        const today = new Date();
        let reminderDate = new Date(today.getFullYear(), today.getMonth(), loan.paymentDay, 10, 0, 0);
        if (today.getDate() > loan.paymentDay) { reminderDate.setMonth(reminderDate.getMonth() + 1); }
        const formatDateForICS = (date) => date.toISOString().replace(/[-:]/g, "").split('.')[0] + 'Z';
        const eventStart = formatDateForICS(reminderDate);
        const eventEnd = formatDateForICS(new Date(reminderDate.getTime() + 60 * 60 * 1000));
        const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//LoanManager//EN\nBEGIN:VEVENT\nUID:${Date.now()}@loanmanager.app\nDTSTAMP:${formatDateForICS(new Date())}\nDTSTART:${eventStart}\nDTEND:${eventEnd}\nSUMMARY:Loan EMI Due: ${loan.loanName}\nDESCRIPTION:Reminder to pay the EMI of ₹${loan.emiAmount.toFixed(2)} for your ${loan.loanName} from ${loan.bankName}.\nRRULE:FREQ=MONTHLY\nEND:VEVENT\nEND:VCALENDAR`.trim().replace(/\n/g, '\r\n');
        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `emi_reminder_${loan.loanName.replace(/\s+/g, '_')}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    loanForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const loanData = { loanName: document.getElementById('loanName').value.trim(), bankName: document.getElementById('bankName').value.trim(), loanAmount: parseFloat(document.getElementById('loanAmount').value), interestRate: parseFloat(document.getElementById('interestRate').value), totalDuration: parseInt(document.getElementById('totalDuration').value), startDate: document.getElementById('startDate').value, paymentDay: parseInt(document.getElementById('paymentDay').value), monthsPaid: parseInt(document.getElementById('monthsPaid').value) };
        if(!loanData.loanName || !loanData.bankName || !loanData.startDate || !loanData.paymentDay || loanData.loanAmount <= 0 || loanData.interestRate < 0 || loanData.totalDuration <= 0 || loanData.monthsPaid < 0 || loanData.monthsPaid > loanData.totalDuration || loanData.paymentDay < 1 || loanData.paymentDay > 28) { alert("Please enter valid data for all fields."); return; }
        loanData.emiAmount = calculateEMI(loanData.loanAmount, loanData.interestRate, loanData.totalDuration);
        loans.push(loanData);
        saveLoans();
        renderLoans();
        loanForm.reset();
    });

    document.addEventListener('DOMContentLoaded', () => { renderLoans(); });
</script>
</body>
</html>